\documentclass[a4paper]{article}

%% packages
%%%%%%%%%%%
\usepackage[utf8x]{inputenc}
\usepackage[USenglish]{babel}
\usepackage{amsbsy,amscd,amsfonts,amssymb,amstext,amsmath,amsthm,latexsym}
\usepackage{mathpartir}
\usepackage{stmaryrd}
\usepackage{dot2texi}
\usepackage{url}
\usepackage{hyperref}
\usepackage[nottoc]{tocbibind}
\usepackage{pdfpages}

\usepackage{syntax} % for bnf grammar
\usepackage{bussproofs} % for type rules
\usepackage{todonotes}

\usepackage{float} % for figures
\floatstyle{boxed}
\restylefloat{figure}

\usepackage{listings}
\usepackage{xcolor}
%\usepackage{tikz}
\usetikzlibrary{positioning,chains,shapes.arrows,shapes.geometric,fit,calc,arrows,decorations.pathmorphing}

%\usepackage{subfig}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{adjustbox}
\usepackage{cleveref}

\input{macros}
%\input{tikz}

\begin{document}
\section{Path Depth Limit Encoding}
To encode: $\entails{\instBy{x}{\Succ}, \instBy{x.p}{\Zero}, \pathEq{x}{y}}{\instOf{y}{\Nat}}$
with $\mathit{depth\!\!-\!\!limit}=1$
\begin{align}
  &\texttt{\Variable} := \{\mathtt{x}, \mathtt{y}\}\\
  &\texttt{\Class} := \{\Zero,\Succ,\Nat\}\\
  &\texttt{\Path} := \{\mathtt{x}, \mathtt{x}.\mathtt{p}, \mathtt{y}, \mathtt{y}.\mathtt{p}\}\\
  % def subst
  &\subst{p}{v}{q} = s :=\\
  &\quad (p=\mathtt{x} \land v=\mathtt{x} \land q=\mathtt{x} \land s=\mathtt{x})~\lor\\
  &\quad (p=\mathtt{x} \land v=\mathtt{x} \land q=\mathtt{x.p} \land s=\mathtt{x.p})~\lor\\
  &\quad (p=\mathtt{x} \land v=\mathtt{x} \land q=\mathtt{y} \land s=\mathtt{y})~\lor\\
  &\quad (p=\mathtt{x} \land v=\mathtt{x} \land q=\mathtt{y.p} \land s=\mathtt{y.p})~\lor\\
  %&\quad (p=\mathtt{x} \land v=\mathtt{y} \land q=\mathtt{x} \land s=\mathtt{x})~\lor\\
  %&\quad (p=\mathtt{x} \land v=\mathtt{y} \land q=\mathtt{x.p} \land s=\mathtt{x})~\lor\\
  %&\quad (p=\mathtt{x} \land v=\mathtt{y} \land q=\mathtt{y} \land s=\mathtt{x})~\lor\\
  %&\quad (p=\mathtt{x} \land v=\mathtt{y} \land q=\mathtt{y.p} \land s=\mathtt{x})~\lor\\
  &\quad (p=\mathtt{x.p} \land v=\mathtt{x} \land q=\mathtt{x} \land s=\mathtt{x.p})~\lor\\
  &\quad (p=\mathtt{x.p} \land v=\mathtt{x} \land q=\mathtt{y} \land s=\mathtt{y.p})~\lor\\
  &\quad~...\\
  % C-Refl
  &\forall p.~\pathEq{p}{p} && \text{(C-Refl)}\\
  % C-Class
  &\forall p, c.~\instBy{p}{c} \rightarrow \instOf{p}{c} && \text{(C-Class)}\\
  % C-Subst: pathEq
  &\forall p, q, v, r, s, a, b, c, d. && \text{(C-Subst)}\\
  &\quad \pathEq{s}{r} \land \subst{p}{v}{r}=a \land \subst{q}{v}{r}=b~\land\\
  &\quad \pathEq{a}{b} \land
         \subst{p}{v}{s}=c \land \subst{q}{v}{s}=d\\
  &\qquad \rightarrow \pathEq{c}{d}\\
  % C-Subst: instOf
  &\forall p, c, v, r, s, a, b. && \text{(C-Subst)}\\
  &\quad \pathEq{s}{r} \land \subst{p}{v}{r}=a~\land\\
  &\quad \instOf{a}{c} \land
         \subst{p}{v}{s}=b\\
  &\qquad \rightarrow \instOf{b}{c}\\
  % C-Subst: instBy
  &\forall p, c, v, r, s, a, b. && \text{(C-Subst)}\\
  &\quad \pathEq{s}{r} \land \subst{p}{v}{r}=a~\land\\
  &\quad \instBy{a}{c} \land
         \subst{p}{v}{s}=b\\
  &\qquad \rightarrow \instBy{b}{c}\\
  % C-Prog
  &\instOf{\mathtt{x}}{\Zero} \rightarrow \instOf{\mathtt{x}}{\Nat} && \text{(C-Prog)}\\
  &\instOf{\mathtt{x.p}}{\Zero} \rightarrow \instOf{\mathtt{x.p}}{\Nat} && \text{(C-Prog)}\\
  &\instOf{\mathtt{x}}{\Succ} \land \instOf{\mathtt{x.p}}{\Nat} \rightarrow \instOf{\mathtt{x}}{\Nat} && \text{(C-Prog)}\\
  &\instOf{\mathtt{y}}{\Zero} \rightarrow \instOf{\mathtt{y}}{\Nat} && \text{(C-Prog)}\\
  &\instOf{\mathtt{y.p}}{\Zero} \rightarrow \instOf{\mathtt{y.p}}{\Nat} && \text{(C-Prog)}\\
  &\instOf{\mathtt{y}}{\Succ} \land \instOf{\mathtt{y.p}}{\Nat} \rightarrow \instOf{\mathtt{y}}{\Nat} && \text{(C-Prog)}\\
  % Entailment
  &\neg (\instBy{\mathtt{x}}{\Succ} \land \instBy{\mathtt{x.p}}{\Zero} \land \pathEq{\mathtt{x}}{\mathtt{y}} \rightarrow \instOf{\mathtt{y}}{\Nat})
\end{align}
\newpage

\section{Ground Encoding}
To encode: $\entails{\instBy{x}{\Succ}, \instBy{x.p}{\Zero}, \pathEq{x}{y}}{\instOf{y}{\Nat}}$
with $\mathit{depth\!\!-\!\!limit}=1$
\setcounter{equation}{0}
% Alternatively for each align block
% \usepackage{etoolbox}
% \AtBeginEnvironment{align}{\setcounter{equation}{0}}
\begin{align}
  &\texttt{\Variable} := \{\mathtt{x}, \mathtt{y}\}\\
  &\texttt{\Class} := \{\Zero,\Succ,\Nat\}\\
  &\texttt{\Path} := \{\mathtt{x}, \mathtt{x.p}, \mathtt{y}, \mathtt{y.p}\}\\
  % C-Refl
  &\pathEq{\mathtt{x}}{\mathtt{x}} \land
  \pathEq{\mathtt{x.p}}{\mathtt{x.p}} \land
  \pathEq{\mathtt{y}}{\mathtt{y}} \land
  \pathEq{\mathtt{y.p}}{\mathtt{y.p}} && \text{(C-Refl)}\\
  % C-Class
  &\instBy{\mathtt{x}}{\Zero} \rightarrow \instOf{\mathtt{x}}{\Zero} && \text{(C-Class)}\\
  &\instBy{\mathtt{x.p}}{\Zero} \rightarrow \instOf{\mathtt{x.p}}{\Zero} && \text{(C-Class)}\\
  & ...  && \text{(C-Class)}\\
  % C-Subst
  & \pathEq{\mathtt{x}}{\mathtt{y}} \land \pathEq{\mathtt{y}}{\mathtt{y}} \rightarrow \pathEq{\mathtt{y}}{\mathtt{x}} && \text{(C-Subst)}\\
  & \pathEq{\mathtt{x}}{\mathtt{y}} \land \instOf{\mathtt{y}}{Nat} \rightarrow \instOf{\mathtt{x}}{\Nat} && \text{(C-Subst)}\\
  & \pathEq{\mathtt{x}}{\mathtt{y}} \land \instBy{\mathtt{y}}{Nat} \rightarrow \instBy{\mathtt{x}}{\Nat} && \text{(C-Subst)}\\
  & ... && \text{(C-Subst)}\\
  % C-Prog
  &\instOf{\mathtt{x}}{\Zero} \rightarrow \instOf{\mathtt{x}}{\Nat} && \text{(C-Prog)}\\
  &\instOf{\mathtt{x.p}}{\Zero} \rightarrow \instOf{\mathtt{x.p}}{\Nat} && \text{(C-Prog)}\\
  &\instOf{\mathtt{x}}{\Succ} \land \instOf{\mathtt{x.p}}{\Nat} \rightarrow \instOf{\mathtt{x}}{\Nat} && \text{(C-Prog)}\\
  &\instOf{\mathtt{y}}{\Zero} \rightarrow \instOf{\mathtt{y}}{\Nat} && \text{(C-Prog)}\\
  &\instOf{\mathtt{y.p}}{\Zero} \rightarrow \instOf{\mathtt{y.p}}{\Nat} && \text{(C-Prog)}\\
  &\instOf{\mathtt{y}}{\Succ} \land \instOf{\mathtt{y.p}}{\Nat} \rightarrow \instOf{\mathtt{y}}{\Nat} && \text{(C-Prog)}\\
  % Many more
  &...\\
  % Entailment
  &\neg (\instBy{\mathtt{x}}{\Succ} \land
        \instBy{\mathtt{x.p}}{\Zero} \land
        \pathEq{\mathtt{x}}{\mathtt{y}} \rightarrow
          \instOf{y}{\Nat})
\end{align}

\newpage
\subsection{Substitution in the Ground Encoding}
We want to finitely enumerate the quantified rule:
\begin{align*}
  % C-Subst: instOf
  &\forall p, c, v, r, s, a, b. && \text{(C-Subst)}\\
  &\quad \pathEq{s}{r} \land \subst{p}{v}{r}=a~\land\\
  &\quad \instOf{a}{c} \land
         \subst{p}{v}{s}=b\\
  &\qquad \rightarrow \instOf{b}{c}
\end{align*}
The na\"ive approach would be to take the cross product of all quantified variables.
This would leave us with a lot of meaningless implications,
e.g. if we instantiate the rule with
$p=\mathtt{x}, v=\mathtt{y}, r=\mathtt{x}, a=\mathtt{y}, s=\mathtt{x}, b=\mathtt{x}, c=\Nat$
\begin{align*}
  % C-Subst: instOf
  &\pathEq{\mathtt{x}}{\mathtt{x}} \land {\color{red}\subst{\mathtt{x}}{\mathtt{y}}{\mathtt{x}}=\mathtt{y}}~\land
  \instOf{\mathtt{y}}{\Nat} \land \subst{\mathtt{x}}{\mathtt{y}}{\mathtt{x}}=\mathtt{x}\\
  &\quad \rightarrow \instOf{\mathtt{x}}{\Nat}
\end{align*}
Since we know the substitution to be false,
we do not have to include this instantiation into the encoding.
Since we only need to include rule instantiations where the substitution
predicate holds and we can calculate the substitution prior
since all quantified variables are known,
we can get rid of the substitution predicate in the encoding altogether.\\
\\
E.g. the inatantiation with
$p=\mathtt{x}, v=\mathtt{x}, r=\mathtt{y}, a=\mathtt{y}, s=\mathtt{x}, b=\mathtt{x}, c=\Nat$
\begin{align*}
  % C-Subst: instOf
  &\pathEq{\mathtt{x}}{\mathtt{y}} \land
   {\color{blue}\subst{\mathtt{x}}{\mathtt{x}}{\mathtt{y}}=\mathtt{y}}~\land
   \instOf{\mathtt{y}}{\Nat} \land
   {\color{blue}\subst{\mathtt{x}}{\mathtt{x}}{\mathtt{x}}=\mathtt{x}}\\
  &\quad \rightarrow \instOf{\mathtt{x}}{\Nat}
\end{align*}
turns into
\[
  \pathEq{\mathtt{x}}{\mathtt{y}} \land \instOf{\mathtt{y}}{Nat} \rightarrow \instOf{\mathtt{x}}{\Nat}
\]

% TODO: scala: filter obvously true stuff out of enumerated rules
% e.g
% @(named, subst-inst-by)
% ((pth_x ≡ pth_x ∧ pth_x.cls = Nat) → pth_x.cls = Nat)
%   -------------
%       obv
% reduce
% (pth_x.cls = Nat → pth_x.cls = Nat)
%  ---------------------------------
%               obv
%
% filter also those where substitution doesn't has an effect?

\end{document}
